#!/usr/bin/env bash

function provision {
  echo "deploying database container... you'll see an error if db has already been deployed. Don't worry about it."
  docker run --name biketag-db -p 25432:5432 -d mdillon/postgis

  echo "pulling latest api container"
  docker pull jackpine/biketag-api

  echo "removing any pre-existing api container"
  docker stop biketag-api
  docker rm biketag-api

  echo "starting new api container"
  docker run --name biketag-api --link biketag-db:biketag-db -p 80:80 -d jackpine/biketag-api
}

if [ "$#" == 1 ]
then
  echo "remote deploying to $1"
  ssh $1 "$(typeset -f); provision"
elif [ "$#" == 1 ]
then
  echo "local deploy"
  provision
else
  echo "Usage ./deploy core@my-host.com"
fi
