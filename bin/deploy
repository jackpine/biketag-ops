#!/usr/bin/env bash

function usage {
  cat <<EOS
Usage: ./deploy <connection-string>
 e.g.: ./deploy core@my-host.com
EOS
}

function provision {
  echo "deploying database container... you'll see an error if db has already been deployed. Don't worry about it."
  docker run --name biketag-db -p 25432:5432 -d mdillon/postgis

  echo "pulling latest api container"
  docker pull jackpine/biketag-api

  echo "removing any pre-existing api container"
  docker stop biketag-api
  docker rm biketag-api

  echo "starting new api container"
  docker run --name biketag-api --link biketag-db:biketag-db -p 80:80 -d jackpine/biketag-api
}

if [ "$#" == 1 ]
then
  echo "remote deploying to $1"
  ssh $1 "$(typeset -f); provision"
else
  usage
  exit 1
fi
