#!/usr/bin/env bash

function usage {
  cat <<EOS
Usage: ./install-ssl
EOS
}

CERTIFICATE_BUNDLE_PATH=~/biketag-ops/secrets/ssl/api_biketag_jackpine_me_bundle.crt

echo 'Bundling certificates.'

# Order of concatenation is essential here.
cat ~/biketag-ops/secrets/ssl/crt/api_biketag_jackpine_me.crt \
    ~/biketag-ops/secrets/ssl/crt/COMODORSADomainValidationSecureServerCA.crt \
    ~/biketag-ops/secrets/ssl/crt/COMODORSAAddTrustCA.crt \
    ~/biketag-ops/secrets/ssl/crt/AddTrustExternalCARoot.crt > $CERTIFICATE_BUNDLE_PATH

echo 'Installing certificate bundle.'
docker exec -i biketag-api bash -c "cat - > /etc/ssl/certs/api_biketag_jackpine_me_bundle.crt" < $CERTIFICATE_BUNDLE_PATH
docker exec biketag-api bash -c "chmod 600 /etc/ssl/certs/api_biketag_jackpine_me_bundle.crt"

echo 'Installing certificate key.'
docker exec -i biketag-api bash -c "cat - > /etc/ssl/private/api_biketag_jackpine_me.key" < ~/biketag-ops/secrets/ssl/api_biketag_jackpine_me.key
docker exec biketag-api bash -c "chmod 600 /etc/ssl/private/api_biketag_jackpine_me.key"

